import{aY as M,S as T,t as y,m as $,d as D,a as v,j as x,k as P,b1 as E,b2 as H,w as j,L as V,b3 as G,s as C,b4 as q,b5 as B,b6 as J,b7 as U,b8 as Q,b9 as K,ba as Z,bb as ee,q as Y,bc as te,bd as ie,a2 as ae,b0 as _,be as O,g as w,bf as F,aa as ne,bg as se,aq as re,bh as le,bi as z,a9 as oe}from"./BBnRYWwF.js";import{o as ue}from"./DA0avTnl.js";import{s as N,m as ce}from"./Zi5LXOru.js";const he="Bubbles",I=12,pe={name:he,defaultParams:j,layerIndex:V,validator:(h,{validateColumns:t})=>{const a=t(h,{force:{toBeTypes:["object"]},bubbleLabel:{toBeTypes:["object"]},arcScaleType:{toBe:'"area" | "radius"',test:l=>l==="area"||l==="radius"}});if(h.force){const l=t(h.force,{velocityDecay:{toBeTypes:["number"]},collisionSpacing:{toBeTypes:["number"]},strength:{toBeTypes:["number"]}});if(l.status==="error")return l}if(h.bubbleLabel){const l=t(h.bubbleLabel,{labelFn:{toBeTypes:["Function"]},colorType:{toBeOption:"ColorType"},fillRate:{toBeTypes:["number"]},lineHeight:{toBeTypes:["number"]},maxLineLength:{toBeTypes:["number"]}});if(l.status==="error")return l}return a}};function ge(h,t){return Q().velocityDecay(t.force.velocityDecay).force("collision",K().radius(a=>a.r+t.force.collisionSpacing)).force("charge",Z().strength(a=>-Math.pow(a.r,2)*t.force.strength)).on("tick",()=>{h.attr("transform",a=>`translate(${a.x},${a.y})`)})}function me({selection:h,bubblesData:t,fullParams:a,fullChartParams:l}){const n=h.selectAll("g").data(t,o=>o.id).join(o=>{const e=o.append("g").attr("cursor","pointer").attr("font-size",I).style("fill","#ffffff").attr("text-anchor","middle");return e.append("circle").attr("class","node").attr("cx",0).attr("cy",0).attr("fill",r=>r.color),e.append("text").style("opacity",.8).attr("pointer-events","none"),e},o=>o,o=>o.remove()).attr("transform",o=>`translate(${o.x},${o.y})`);return n.select("circle").transition().duration(200).attr("r",o=>o.r).attr("fill",o=>o.color),n.each((o,e,r)=>{const i=C(r[e]),p=o.renderLabel;i.call(ee,{text:p,radius:o.r*a.bubbleLabel.fillRate,lineHeight:I*a.bubbleLabel.lineHeight,isBreakAll:p.length<=a.bubbleLabel.maxLineLength?!1:a.bubbleLabel.wordBreakAll}),i.select("text").attr("fill",g=>Y({datum:o,colorType:a.bubbleLabel.colorType,fullChartParams:l}))}),n}function fe(h){return G().on("start",(t,a)=>{t.active||h.alpha(1).restart(),a.fx=a.x,a.fy=a.y}).on("drag",(t,a)=>{t.active||h.alphaTarget(0),a.fx=t.x,a.fy=t.y}).on("end",(t,a)=>{a.fx=null,a.fy=null,h.alpha(1).restart()})}function be({_simulation:h,fullParams:t,DatumContainerPositionMap:a}){h.force("x",te().strength(t.force.strength).x(l=>{let n=a.get(l.id);return n||(n=a.get(Array.from(a.keys())[0])),(n==null?void 0:n.centerX)??null})).force("y",ie().strength(t.force.strength).y(l=>{let n=a.get(l.id);return n||(n=a.get(Array.from(a.keys())[0])),(n==null?void 0:n.centerY)??null}))}function de({bubblesSelection:h,highlightIds:t,fullChartParams:a}){if(h.interrupt("highlight"),!t.length){h.transition("highlight").style("opacity",1);return}h.each((l,n,o)=>{const e=C(o[n]);t.includes(l.id)?e.style("opacity",1).transition("highlight").ease(q).duration(500):e.style("opacity",a.styles.unhighlightedOpacity)})}const He=M(pe)(({selection:h,name:t,observer:a,subject:l})=>{const n=new T;let o;const e=a.fullParams$.pipe(y(n),$(u=>u.arcScaleType),D(),v(1)),r=a.layout$.pipe(y(n),$(u=>Math.min(u.width,u.height)/2),D(),v(1)),i=a.visibleComputedSortedData$.pipe(y(n),$(u=>u.flat().reduce((d,f)=>d+f.value,0)),D(),v(1)),p=x({totalR:r,totalValue:i,scaleType:e}).pipe(y(n),P(async u=>u),$(u=>B().domain([0,u.totalValue]).range([0,u.totalR]).exponent(u.scaleType==="area"?.5:1)),v(1)),g=e.pipe(y(n),P(u=>J(()=>u==="area",ue(1),x({totalR:r,radiusScale:p,visibleComputedSortedData:a.visibleComputedSortedData$}).pipe(P(async d=>d),$(d=>{const f=d.totalR*d.totalR*Math.PI;return Math.sqrt(f/U(d.visibleComputedSortedData.flat(),A=>Math.PI*Math.pow(d.radiusScale(A.value),2)))}))))),c=x({visibleComputedSortedData:a.visibleComputedSortedData$,radiusScale:p,scaleFactor:g}).pipe(y(n),P(async u=>u),$(u=>new Map(u.visibleComputedSortedData.flat().map(f=>[f.id,u.radiusScale(f.value??0)*u.scaleFactor*.9]))),v(1)),S=a.DatumContainerPositionMap$.pipe(y(n),E(u=>u.size>0),$(u=>new Map(Array.from(u).map(([d,f])=>[d,{x:f.startX+f.width*Math.random(),y:f.startY+f.height*Math.random()}]))),H(),v(1)),s=x({visibleComputedSortedData:a.visibleComputedSortedData$,DatumRMap:c,DatumInitXYMap:S,fullParams:a.fullParams$}).pipe(y(n),P(async u=>u),$(u=>u.visibleComputedSortedData.flat().map(d=>{const f=d;if(f.x===void 0||f.y===void 0){let A=u.DatumInitXYMap.get(f.id);A||(A=u.DatumInitXYMap.get(Array.from(u.DatumInitXYMap.keys())[0])),f.x=A.x,f.y=A.y}return f.r=u.DatumRMap.get(f.id),f._originR=f.r,f.renderLabel=u.fullParams.bubbleLabel.labelFn(f),f})),v(1)),m=a.fullChartParams$.pipe(y(n),$(u=>u.highlightTarget),D()),b=x({bubblesData:s,fullParams:a.fullParams$,fullChartParams:a.fullChartParams$,DatumContainerPositionMap:a.DatumContainerPositionMap$}).pipe(y(n),P(async u=>u),$(u=>{o&&o.stop();const d=me({selection:h,bubblesData:u.bubblesData,fullParams:u.fullParams,fullChartParams:u.fullChartParams});return o=ge(d,u.fullParams),o.nodes(u.bubblesData),be({_simulation:o,fullParams:u.fullParams,DatumContainerPositionMap:u.DatumContainerPositionMap}),o.alpha(1).restart(),d}),v(1));return x({bubblesSelection:b,computedData:a.computedData$,SeriesDataMap:a.SeriesDataMap$,highlightTarget:m}).pipe(y(n),P(async u=>u)).subscribe(u=>{u.bubblesSelection.on("mouseover",(d,f)=>{l.event$.next({type:"series",eventName:"mouseover",pluginName:t,highlightTarget:u.highlightTarget,datum:f,series:u.SeriesDataMap.get(f.seriesLabel),seriesIndex:f.seriesIndex,seriesLabel:f.seriesLabel,event:d,data:u.computedData})}).on("mousemove",(d,f)=>{l.event$.next({type:"series",eventName:"mousemove",pluginName:t,highlightTarget:u.highlightTarget,datum:f,series:u.SeriesDataMap.get(f.seriesLabel),seriesIndex:f.seriesIndex,seriesLabel:f.seriesLabel,event:d,data:u.computedData})}).on("mouseout",(d,f)=>{l.event$.next({type:"series",eventName:"mouseout",pluginName:t,highlightTarget:u.highlightTarget,datum:f,series:u.SeriesDataMap.get(f.seriesLabel),seriesIndex:f.seriesIndex,seriesLabel:f.seriesLabel,event:d,data:u.computedData})}).on("click",(d,f)=>{l.event$.next({type:"series",eventName:"click",pluginName:t,highlightTarget:u.highlightTarget,datum:f,series:u.SeriesDataMap.get(f.seriesLabel),seriesIndex:f.seriesIndex,seriesLabel:f.seriesLabel,event:d,data:u.computedData})}).call(fe(o))}),x({bubblesSelection:b,highlight:a.seriesHighlight$.pipe($(u=>u.map(d=>d.id))),fullChartParams:a.fullChartParams$}).pipe(y(n),P(async u=>u)).subscribe(u=>{de({bubblesSelection:u.bubblesSelection,highlightIds:u.highlight,fullChartParams:u.fullChartParams})}),()=>{n.next(void 0),o&&(o.stop(),o=void 0)}}),L="PieLabels",Se=w(L,"label-g"),ye=w(L,"line-g"),$e=w(L,"text"),W=2,Pe={name:L,defaultParams:ae,layerIndex:_,validator:(h,{validateColumns:t})=>t(h,{outerRadius:{toBeTypes:["number"]},outerRadiusWhileHighlight:{toBeTypes:["number"]},startAngle:{toBeTypes:["number"]},endAngle:{toBeTypes:["number"]},labelCentroid:{toBeTypes:["number"]},labelFn:{toBeTypes:["Function"]},labelColorType:{toBeOption:"ColorType"}})};function xe({pieData:h,arc:t,arcMouseover:a,labelCentroid:l,lineStartCentroid:n,fullParams:o}){return h.map((e,r)=>{const[i,p]=t.centroid(e),[g,c]=a.centroid(e),S=o.labelFn(e.data);return{pieDatum:e,arcIndex:r,arcLabels:S.split(`
`),lineStartX:i*n,lineStartY:p*n,lineStartMouseoverX:g*n,lineStartMouseoverY:c*n,x:i*l,y:p*l,mouseoverX:g*l,mouseoverY:c*l,textWidth:0,collisionShiftX:0,collisionShiftY:0,quadrant:i>=0&&p<=0?1:i<0&&p<=0?2:i<0&&p>0?3:4}}).filter(e=>e.pieDatum.data.visible)}function Ce({labelGSelection:h,data:t,fullParams:a,fullChartParams:l,textSizePx:n}){const o=h.selectAll("text").data(t,e=>e.pieDatum.id).join("text").classed($e,!0).attr("font-weight","bold").attr("text-anchor",e=>e.quadrant==1||e.quadrant==4?"start":"end").style("dominant-baseline",e=>e.quadrant==1||e.quadrant==2?"auto":"hanging").style("cursor",e=>l.highlightTarget&&l.highlightTarget!="none"?"pointer":"none").attr("font-size",l.styles.textSize).attr("x",0).attr("y",0).attr("fill",(e,r)=>Y({datum:e.pieDatum.data,colorType:a.labelColorType,fullChartParams:l})).each((e,r,i)=>{F(C(i[r]),{textArr:e.arcLabels,textSizePx:n,quadrant:e.quadrant})});return o.transition().attr("transform",e=>"translate("+e.x+","+e.y+")"),o}function De(h,t,a){const l=h.nodes(),n=a,o=l.map((e,r)=>{const i=e.getBBox(),p=[t[r].x,t[r].y];return{node:e,x:p[0],y:p[1],width:i.width,height:i.height}});for(let e=0;e<o.length;e++){const r=o[e];for(let i=e+1;i<o.length;i++){const p=o[i];t[e].textWidth=r.width;const g=r.x+t[e].collisionShiftX,c=r.y+t[e].collisionShiftY,S=p.x+t[i].collisionShiftX,s=p.y+t[i].collisionShiftY;if(!(g+r.width/2<S-p.width/2||g-r.width/2>S+p.width/2||c+r.height/2<s-p.height/2||c-r.height/2>s+p.height/2)){if(t[i].quadrant==2){const m=s>c?-n*2:-n;t[i].collisionShiftY+=m}else if(t[i].quadrant==4){const m=s>c?n:n*2;t[i].collisionShiftY+=m}}}}for(let e=o.length-1;e>=0;e--){const r=o[e];for(let i=e-1;i>=0;i--){const p=o[i];t[e].textWidth=r.width;const g=r.x+t[e].collisionShiftX,c=r.y+t[e].collisionShiftY,S=p.x+t[i].collisionShiftX,s=p.y+t[i].collisionShiftY;if(!(g+r.width/2<S-p.width/2||g-r.width/2>S+p.width/2||c+r.height/2<s-p.height/2||c-r.height/2>s+p.height/2)){if(t[i].quadrant==1){const m=s>c?-n*2:-n;t[i].collisionShiftY+=m}else if(t[i].quadrant==3){const m=s>c?n:n*2;t[i].collisionShiftY+=m}}}}h.data(t).transition().attr("transform",e=>`translate(${e.x+e.collisionShiftX},${e.y+e.collisionShiftY})`)}function Te({lineGSelection:h,data:t,fullParams:a,fullChartParams:l}){const n=t.filter(e=>e.collisionShiftX||e.collisionShiftY),o=h.selectAll("polyline").data(n,e=>e.pieDatum.id).join("polyline").attr("stroke",e=>Y({datum:e.pieDatum.data,colorType:a.labelColorType,fullChartParams:l})).attr("stroke-width",1).attr("fill","none").attr("points",e=>[[e.lineStartX,e.lineStartY],[e.lineStartX,e.lineStartY]]);return o.transition().attr("points",e=>{let r=e.x+e.collisionShiftX,i=e.y+e.collisionShiftY;return[[r,i],[e.lineStartX,e.lineStartY]]}),o}function ve({textSelection:h,lineSelection:t,ids:a,fullChartParams:l}){if(h.interrupt("highlight"),t.interrupt("highlight"),!a.length){h.transition("highlight").duration(200).attr("transform",n=>`translate(${n.x+n.collisionShiftX},${n.y+n.collisionShiftY})`).style("opacity",1),t.transition("highlight").duration(200).style("opacity",1);return}h.each((n,o,e)=>{const r=C(e[o]);a.includes(n.pieDatum.id)?r.style("opacity",1).transition("highlight").duration(200).attr("transform",i=>i.collisionShiftX||i.collisionShiftY?`translate(${i.x+i.collisionShiftX},${i.y+i.collisionShiftY})`:`translate(${i.mouseoverX+i.collisionShiftX},${i.mouseoverY+i.collisionShiftY})`):r.style("opacity",l.styles.unhighlightedOpacity).transition("highlight").duration(200).attr("transform",i=>`translate(${i.x+i.collisionShiftX},${i.y+i.collisionShiftY})`)}),t.each((n,o,e)=>{const r=C(e[o]);a.includes(n.pieDatum.data.id)?r.style("opacity",1).transition("highlight").duration(200):r.style("opacity",l.styles.unhighlightedOpacity).transition("highlight").duration(200)})}function Ae(h,t){const a=new T;t.containerSelection.selectAll("g").remove();const l=t.containerSelection.append("g");l.classed(ye,!0);const n=t.containerSelection.append("g");n.classed(Se,!0);const o=new T,e=new T;let r=[];const i=t.seriesContainerPosition$.pipe(y(a),$(g=>g.width<g.height?g.width:g.height),D()),p=t.fullParams$.pipe(y(a),$(g=>g.labelCentroid>=W?W:g.labelCentroid));return x({shorterSideWith:i,containerVisibleComputedSortedData:t.containerVisibleComputedSortedData$,fullParams:t.fullParams$,fullChartParams:t.fullChartParams$,textSizePx:t.textSizePx$,lineStartCentroid:p}).pipe(y(a),P(async g=>g)).subscribe(g=>{const c=O({axisWidth:g.shorterSideWith,innerRadius:0,outerRadius:g.fullParams.outerRadius,padAngle:0,cornerRadius:0}),S=O({axisWidth:g.shorterSideWith,innerRadius:0,outerRadius:g.fullParams.outerRadiusWhileHighlight,padAngle:0,cornerRadius:0}),s=ce({data:g.containerVisibleComputedSortedData,startAngle:g.fullParams.startAngle,endAngle:g.fullParams.endAngle});r=xe({pieData:s,arc:c,arcMouseover:S,labelCentroid:g.fullParams.labelCentroid,lineStartCentroid:g.lineStartCentroid,fullParams:g.fullParams}),l.selectAll("polyline").remove();const m=Ce({labelGSelection:n,data:r,fullParams:g.fullParams,fullChartParams:g.fullChartParams,textSizePx:g.textSizePx});setTimeout(()=>{De(m,r,g.textSizePx);const b=Te({lineGSelection:l,data:r,fullParams:g.fullParams,fullChartParams:g.fullChartParams});e.next(b)},1e3),o.next(m)}),x({textSelection:o,lineSelection:e,highlight:t.seriesHighlight$.pipe($(g=>g.map(c=>c.id))),fullChartParams:t.fullChartParams$}).pipe(y(a),P(async g=>g)).subscribe(g=>{ve({textSelection:g.textSelection,lineSelection:g.lineSelection,ids:g.highlight,fullChartParams:g.fullChartParams})}),()=>{a.next(void 0)}}const je=M(Pe)(({selection:h,observer:t,subject:a})=>{const l=new T,{seriesCenterSelection$:n}=N({selection:h,pluginName:L,visibleComputedSortedData$:t.visibleComputedSortedData$,seriesContainerPosition$:t.seriesContainerPosition$}),o=[];return n.pipe(y(l)).subscribe(e=>{o.forEach(r=>r()),e.each((r,i,p)=>{const g=C(p[i]),c=t.visibleComputedSortedData$.pipe(y(l),$(s=>s[i]??s[0])),S=t.seriesContainerPosition$.pipe(y(l),$(s=>s[i]??s[0]));o[i]=Ae(L,{containerSelection:g,containerVisibleComputedSortedData$:c,fullParams$:t.fullParams$,fullChartParams$:t.fullChartParams$,textSizePx$:t.textSizePx$,seriesHighlight$:t.seriesHighlight$,seriesContainerPosition$:S,event$:a.event$})})}),()=>{l.next(void 0)}}),X="Rose",we=Math.PI*2,Le={name:X,defaultParams:ne,layerIndex:V,validator:(h,{validateColumns:t})=>t(h,{outerRadius:{toBeTypes:["number"]},padAngle:{toBeTypes:["number"]},strokeColorType:{toBeOption:"ColorType"},strokeWidth:{toBeTypes:["number"]},cornerRadius:{toBeTypes:["number"]},arcScaleType:{toBe:'"area" | "radius"',test:l=>l==="area"||l==="radius"},angleIncreaseWhileHighlight:{toBeTypes:["number"]}})};function Re({cornerRadius:h,outerRadius:t,axisWidth:a,maxValue:l,arcScaleType:n,fullParams:o}){const e=a/2*t,r=n==="area"?.5:1,i=B().domain([0,l]).range([0,e]).exponent(r);return p=>{const g=i(p.prevValue),c=i(p.value),S=le(g,c);return s=>{const m=S(s);return z().innerRadius(0).outerRadius(m).padAngle(o.padAngle).padRadius(m).cornerRadius(h)(p)}}}function Ye({pathSelection:h,ids:t,fullParams:a,fullChartParams:l,tweenArc:n}){if(h.interrupt("highlight"),!t.length){h.transition("highlight").style("opacity",1).attr("d",o=>n(o)(1));return}h.each((o,e,r)=>{const i=C(r[e]);t.includes(o.data.id)?i.style("opacity",1).transition("highlight").ease(q).duration(500).attr("d",p=>n({...p,startAngle:p.startAngle-a.angleIncreaseWhileHighlight,endAngle:p.endAngle+a.angleIncreaseWhileHighlight})(1)):i.style("opacity",l.styles.unhighlightedOpacity).transition("highlight").attr("d",p=>n(p)(1))})}function Me(h,t){const a=new T,l=w(h,"path");let n=[];const o=t.seriesContainerPosition$.pipe(y(a),$(s=>s.width<s.height?s.width:s.height),D()),e=x({containerVisibleComputedSortedData:t.containerVisibleComputedSortedData$,fullParams:t.fullParams$}).pipe(y(a),P(async s=>s),$(s=>{const m=we/s.containerVisibleComputedSortedData.length;return s.containerVisibleComputedSortedData.map((b,u)=>({id:b.id,data:b,index:u,value:b.value,startAngle:m*u,endAngle:m*(u+1),padAngle:s.fullParams.padAngle,prevValue:n[u]&&n[u].id===b.id?n[u].value:0}))})),r=t.fullChartParams$.pipe(y(a),$(s=>s.highlightTarget),D()),i=t.visibleComputedSortedData$.pipe($(s=>Math.max(...s.flat().map(m=>m.value))),D()),p=x({fullParams:t.fullParams$,axisWidth:o,maxValue:i}).pipe(y(a),P(async s=>s),$(s=>Re({cornerRadius:s.fullParams.cornerRadius,outerRadius:s.fullParams.outerRadius,axisWidth:s.axisWidth,maxValue:s.maxValue,arcScaleType:s.fullParams.arcScaleType,fullParams:s.fullParams}))),g=t.fullChartParams$.pipe(y(a),$(s=>s.transitionDuration),D()),c=new se(!1),S=new re(s=>{x({pieData:e,tweenArc:p,transitionDuration:g,fullParams:t.fullParams$,fullChartParams:t.fullChartParams$}).pipe(y(a),P(async m=>m)).subscribe(m=>{const b=m.pieData.map((d,f)=>(d.prevValue=n[f]&&n[f].id===d.id?n[f].value:0,d));c.next(!0);const u=t.containerSelection.selectAll("path").data(b,d=>d.id).join("path").classed(l,!0).style("cursor","pointer").attr("fill",(d,f)=>d.data.color).attr("stroke",(d,f)=>Y({datum:d.data,colorType:m.fullParams.strokeColorType,fullChartParams:m.fullChartParams})).attr("stroke-width",m.fullParams.strokeWidth);u.interrupt("graphicMove"),u.transition("graphicMove").duration(m.transitionDuration).attrTween("d",m.tweenArc).on("end",()=>{s.next(u),c.next(!1)}),n=Object.assign([],b)})}).pipe(v(1));return x({pathSelection:S,SeriesDataMap:t.SeriesDataMap$,computedData:t.computedData$,highlightTarget:r}).pipe(y(a),P(async s=>s)).subscribe(s=>{s.pathSelection.on("mouseover",(m,b)=>{m.stopPropagation(),t.event$.next({type:"series",eventName:"mouseover",pluginName:h,highlightTarget:s.highlightTarget,datum:b.data,series:s.SeriesDataMap.get(b.data.seriesLabel),seriesIndex:b.data.seriesIndex,seriesLabel:b.data.seriesLabel,event:m,data:s.computedData})}).on("mousemove",(m,b)=>{m.stopPropagation(),t.event$.next({type:"series",eventName:"mousemove",pluginName:h,highlightTarget:s.highlightTarget,datum:b.data,series:s.SeriesDataMap.get(b.data.seriesLabel),seriesIndex:b.data.seriesIndex,seriesLabel:b.data.seriesLabel,event:m,data:s.computedData})}).on("mouseout",(m,b)=>{m.stopPropagation(),t.event$.next({type:"series",eventName:"mouseout",pluginName:h,highlightTarget:s.highlightTarget,datum:b.data,series:s.SeriesDataMap.get(b.data.seriesLabel),seriesIndex:b.data.seriesIndex,seriesLabel:b.data.seriesLabel,event:m,data:s.computedData})}).on("click",(m,b)=>{m.stopPropagation(),t.event$.next({type:"series",eventName:"click",pluginName:h,highlightTarget:s.highlightTarget,datum:b.data,series:s.SeriesDataMap.get(b.data.seriesLabel),seriesIndex:b.data.seriesIndex,seriesLabel:b.data.seriesLabel,event:m,data:s.computedData})})}),x({pathSelection:S,highlight:t.seriesHighlight$.pipe($(s=>s.map(m=>m.id))),fullParams:t.fullParams$,fullChartParams:t.fullChartParams$,tweenArc:p,isTransitionMoving:c}).pipe(y(a),P(async s=>s),E(s=>!s.isTransitionMoving)).subscribe(s=>{Ye({pathSelection:s.pathSelection,ids:s.highlight,fullParams:s.fullParams,fullChartParams:s.fullChartParams,tweenArc:s.tweenArc})}),()=>{a.next(void 0)}}const Ge=M(Le)(({selection:h,name:t,subject:a,observer:l})=>{const n=new T,{seriesCenterSelection$:o}=N({selection:h,pluginName:X,visibleComputedSortedData$:l.visibleComputedSortedData$,seriesContainerPosition$:l.seriesContainerPosition$}),e=[];return o.pipe(y(n)).subscribe(r=>{e.forEach(i=>i()),r.each((i,p,g)=>{const c=C(g[p]),S=l.visibleComputedSortedData$.pipe(y(n),$(m=>JSON.parse(JSON.stringify(m[p]??m[0])))),s=l.seriesContainerPosition$.pipe(y(n),$(m=>JSON.parse(JSON.stringify(m[p]??m[0]))));e[p]=Me(X,{containerSelection:c,computedData$:l.computedData$,visibleComputedSortedData$:l.visibleComputedSortedData$,containerVisibleComputedSortedData$:S,SeriesDataMap$:l.SeriesDataMap$,fullParams$:l.fullParams$,fullChartParams$:l.fullChartParams$,seriesHighlight$:l.seriesHighlight$,seriesContainerPosition$:s,event$:a.event$})})}),()=>{n.next(void 0),e.forEach(r=>r())}}),R="RoseLabels",Xe=w(R,"label-g"),Be=w(R,"line-g"),Ne=w(R,"text"),k=2,Oe={name:R,defaultParams:oe,layerIndex:_,validator:(h,{validateColumns:t})=>t(h,{outerRadius:{toBeTypes:["number"]},labelCentroid:{toBeTypes:["number"]},labelFn:{toBeTypes:["Function"]},labelColorType:{toBeOption:"ColorType"},arcScaleType:{toBe:'"area" | "radius"',test:l=>l==="area"||l==="radius"}})};function Ie({pieData:h,labelCentroid:t,arcScaleType:a,maxValue:l,axisWidth:n,outerRadius:o,lineStartCentroid:e,fullParams:r}){const i=n/2*o,p=a==="area"?.5:1,g=B().domain([0,l]).range([0,i]).exponent(p);return h.map((c,S)=>{const s=g(c.value),m=z().innerRadius(0).outerRadius(s).padAngle(0).padRadius(s).cornerRadius(0),[b,u]=m.centroid(c),[d,f]=[b,u],A=r.labelFn(c.data);return{pieDatum:c,arcIndex:S,arcLabels:A.split(`
`),lineStartX:b*e,lineStartY:u*e,lineStartMouseoverX:d*e,lineStartMouseoverY:f*e,x:b*t,y:u*t,mouseoverX:d*t,mouseoverY:f*t,textWidth:0,collisionShiftX:0,collisionShiftY:0,quadrant:b>=0&&u<=0?1:b<0&&u<=0?2:b<0&&u>0?3:4}}).filter(c=>c.pieDatum.data.visible)}function We({labelGSelection:h,data:t,fullParams:a,fullChartParams:l,textSizePx:n}){const o=h.selectAll("text").data(t,e=>e.pieDatum.id).join("text").classed(Ne,!0).attr("font-weight","bold").attr("text-anchor",e=>e.quadrant==1||e.quadrant==4?"start":"end").style("dominant-baseline",e=>e.quadrant==1||e.quadrant==2?"auto":"hanging").style("cursor",e=>l.highlightTarget&&l.highlightTarget!="none"?"pointer":"none").attr("font-size",l.styles.textSize).attr("fill",(e,r)=>Y({datum:e.pieDatum.data,colorType:a.labelColorType,fullChartParams:l})).each((e,r,i)=>{F(C(i[r]),{textArr:e.arcLabels,textSizePx:n,quadrant:e.quadrant})});return o.transition().attr("transform",e=>"translate("+e.x+","+e.y+")"),o}function ke(h,t,a){const l=h.nodes(),n=a,o=l.map((e,r)=>{const i=e.getBBox(),p=[t[r].x,t[r].y];return{node:e,x:p[0],y:p[1],width:i.width,height:i.height}});for(let e=0;e<o.length;e++){const r=o[e];for(let i=e+1;i<o.length;i++){const p=o[i];t[e].textWidth=r.width;const g=r.x+t[e].collisionShiftX,c=r.y+t[e].collisionShiftY,S=p.x+t[i].collisionShiftX,s=p.y+t[i].collisionShiftY;if(!(g+r.width/2<S-p.width/2||g-r.width/2>S+p.width/2||c+r.height/2<s-p.height/2||c-r.height/2>s+p.height/2)){if(t[i].quadrant==2){const m=s>c?-n*2:-n;t[i].collisionShiftY+=m}else if(t[i].quadrant==4){const m=s>c?n:n*2;t[i].collisionShiftY+=m}}}}for(let e=o.length-1;e>=0;e--){const r=o[e];for(let i=e-1;i>=0;i--){const p=o[i];t[e].textWidth=r.width;const g=r.x+t[e].collisionShiftX,c=r.y+t[e].collisionShiftY,S=p.x+t[i].collisionShiftX,s=p.y+t[i].collisionShiftY;if(!(g+r.width/2<S-p.width/2||g-r.width/2>S+p.width/2||c+r.height/2<s-p.height/2||c-r.height/2>s+p.height/2)){if(t[i].quadrant==1){const m=s>c?-n*2:-n;t[i].collisionShiftY+=m}else if(t[i].quadrant==3){const m=s>c?n:n*2;t[i].collisionShiftY+=m}}}}h.data(t).transition().attr("transform",e=>`translate(${e.x+e.collisionShiftX},${e.y+e.collisionShiftY})`)}function Ee({lineGSelection:h,data:t,fullParams:a,fullChartParams:l}){const n=t.filter(e=>e.collisionShiftX||e.collisionShiftY),o=h.selectAll("polyline").data(n,e=>e.pieDatum.id).join("polyline").attr("stroke",e=>Y({datum:e.pieDatum.data,colorType:a.labelColorType,fullChartParams:l})).attr("stroke-width",1).attr("fill","none").attr("points",e=>[[e.lineStartX,e.lineStartY],[e.lineStartX,e.lineStartY]]);return o.transition().attr("points",e=>{let r=e.x+e.collisionShiftX,i=e.y+e.collisionShiftY;return[[r,i],[e.lineStartX,e.lineStartY]]}),o}function Ve({textSelection:h,lineSelection:t,ids:a,fullChartParams:l}){if(h.interrupt("highlight"),t.interrupt("highlight"),!a.length){h.transition("highlight").duration(200).attr("transform",n=>`translate(${n.x+n.collisionShiftX},${n.y+n.collisionShiftY})`).style("opacity",1),t.transition("highlight").duration(200).style("opacity",1);return}h.each((n,o,e)=>{const r=C(e[o]);a.includes(n.pieDatum.data.id)?r.style("opacity",1).transition("highlight").duration(200).attr("transform",i=>`translate(${i.mouseoverX+i.collisionShiftX},${i.mouseoverY+i.collisionShiftY})`):r.style("opacity",l.styles.unhighlightedOpacity).transition("highlight").duration(200).attr("transform",i=>`translate(${i.x+i.collisionShiftX},${i.y+i.collisionShiftY})`)}),t.each((n,o,e)=>{const r=C(e[o]);a.includes(n.pieDatum.data.id)?r.style("opacity",1).transition("highlight").duration(200):r.style("opacity",l.styles.unhighlightedOpacity).transition("highlight").duration(200)})}function qe(h,t){const a=new T;t.containerSelection.selectAll("g").remove();const l=t.containerSelection.append("g");l.classed(Be,!0);const n=t.containerSelection.append("g");n.classed(Xe,!0);const o=new T,e=new T;let r=[];const i=t.seriesContainerPosition$.pipe(y(a),$(c=>c.width<c.height?c.width:c.height),D()),p=t.visibleComputedSortedData$.pipe($(c=>Math.max(...c.flat().map(S=>S.value))),D()),g=t.fullParams$.pipe(y(a),$(c=>c.labelCentroid>=k?k:c.labelCentroid));return x({shorterSideWith:i,containerVisibleComputedSortedData:t.containerVisibleComputedSortedData$,maxValue:p,fullParams:t.fullParams$,fullChartParams:t.fullChartParams$,textSizePx:t.textSizePx$,lineStartCentroid:g}).pipe(y(a),P(async c=>c)).subscribe(c=>{const S=Math.PI*2/c.containerVisibleComputedSortedData.length,s=c.containerVisibleComputedSortedData.map((b,u)=>({id:b.id,data:b,index:u,value:b.value,startAngle:S*u,endAngle:S*(u+1),padAngle:0}));r=Ie({pieData:s,labelCentroid:c.fullParams.labelCentroid,arcScaleType:c.fullParams.arcScaleType,maxValue:c.maxValue,axisWidth:c.shorterSideWith,outerRadius:c.fullParams.outerRadius,lineStartCentroid:c.lineStartCentroid,fullParams:c.fullParams}),l.selectAll("polyline").remove();const m=We({labelGSelection:n,data:r,fullParams:c.fullParams,fullChartParams:c.fullChartParams,textSizePx:c.textSizePx});setTimeout(()=>{ke(m,r,c.textSizePx);const b=Ee({lineGSelection:l,data:r,fullParams:c.fullParams,fullChartParams:c.fullChartParams});e.next(b)},1e3),o.next(m)}),x({textSelection:o,lineSelection:e,highlight:t.seriesHighlight$.pipe($(c=>c.map(S=>S.id))),fullChartParams:t.fullChartParams$}).pipe(y(a),P(async c=>c)).subscribe(c=>{Ve({textSelection:c.textSelection,lineSelection:c.lineSelection,ids:c.highlight,fullChartParams:c.fullChartParams})}),()=>{a.next(void 0)}}const Je=M(Oe)(({selection:h,observer:t,subject:a})=>{const l=new T,{seriesCenterSelection$:n}=N({selection:h,pluginName:R,visibleComputedSortedData$:t.visibleComputedSortedData$,seriesContainerPosition$:t.seriesContainerPosition$}),o=[];return n.pipe(y(l)).subscribe(e=>{o.forEach(r=>r()),e.each((r,i,p)=>{const g=C(p[i]),c=t.visibleComputedSortedData$.pipe(y(l),$(s=>JSON.parse(JSON.stringify(s[i]??s[0])))),S=t.seriesContainerPosition$.pipe(y(l),$(s=>JSON.parse(JSON.stringify(s[i]??s[0]))));o[i]=qe(R,{containerSelection:g,visibleComputedSortedData$:t.visibleComputedSortedData$,containerVisibleComputedSortedData$:c,fullParams$:t.fullParams$,fullChartParams$:t.fullChartParams$,textSizePx$:t.textSizePx$,seriesHighlight$:t.seriesHighlight$,seriesContainerPosition$:S,event$:a.event$})})}),()=>{l.next(void 0)}});export{He as B,je as P,Ge as R,Je as a};
